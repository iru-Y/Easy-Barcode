"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.indexHtml = indexHtml;
const fs_1 = require("fs");
const glob = require("glob");
const variables_reducer_1 = require("./variables-reducer");
function indexHtml(browserOutputDir, serverOutputDir, locales = [], raw, runtime = false) {
    try {
        glob
            .sync(`${browserOutputDir}/**/index{.html,.csr.html}`)
            .forEach((filePath) => {
            const html = (0, fs_1.readFileSync)(filePath, "utf-8");
            const content = (0, variables_reducer_1.variablesReducer)(html, raw); // Replace %VARIABLE% with the actual value
            try {
                (0, fs_1.writeFileSync)(filePath, runtime
                    ? content.replace(/<head>/, `<head><script src="/ngx-env.js"></script>`)
                    : content);
            }
            catch (e) {
                console.log(`‚ùå Failed to replace variables in ${filePath} ‚ùå`);
                throw e;
            }
        });
        if (serverOutputDir) {
            glob
                .sync(`${serverOutputDir}/**/index.server.html`)
                .forEach((filePath) => {
                const html = (0, fs_1.readFileSync)(filePath, "utf-8");
                const content = (0, variables_reducer_1.variablesReducer)(html, raw); // Replace %VARIABLE% with the actual value
                try {
                    (0, fs_1.writeFileSync)(filePath, content);
                }
                catch (e) {
                    console.log(`‚ùå Failed to replace variables in ${filePath} ‚ùå`);
                    throw e;
                }
            });
        }
        if (runtime) {
            // NODE_ENV should not be controlled via runtime
            delete raw.NODE_ENV;
            const runtimeStmt = `globalThis._NGX_ENV_ = ${JSON.stringify(raw, null, 2)};`;
            if (locales.length > 0) {
                locales.forEach((locale) => {
                    console.log(`üì¶ Writing ngx-env.js to ${browserOutputDir}/${locale}/ngx-env.js`);
                    try {
                        (0, fs_1.writeFileSync)(`${browserOutputDir}/${locale}/ngx-env.js`, runtimeStmt);
                    }
                    catch (e) {
                        console.log(`‚ùå Failed to create ngx-env.js at ${browserOutputDir}/${locale}/ngx-env.js ‚ùå`);
                        throw e;
                    }
                });
            }
            else {
                try {
                    console.log(`üì¶ Writing ngx-env.js to ${browserOutputDir}/ngx-env.js`);
                    (0, fs_1.writeFileSync)(`${browserOutputDir}/ngx-env.js`, runtimeStmt);
                }
                catch (e) {
                    console.log(`‚ùå Failed to create ngx-env.js at ${browserOutputDir}/ngx-env.js ‚ùå`);
                    throw e;
                }
            }
        }
    }
    catch (e) {
        console.error(e);
    }
}
//# sourceMappingURL=index-html-build.js.map